---
title: "Study One: Confirmatory Data Analysis"
author: "Joel Larwood"
date: "2019-09-23"
output:
  workflowr::wflow_html:
    code_folding: hide
editor_options:
  chunk_output_type: console
---

# Pre-registration 

Does trait rumination moderate changes in sadness when listening to music known by the listener to be sad during a sad state? We predict that a moderating relationship will not be found and that sadness will decrease regardless of rumination levels 

```{r processdata, message = FALSE, results = "hide", warning = FALSE}
library(tidyverse)
library(papaja)
library(lmerTest)
library(sjPlot)
library(emmeans)
knitr::opts_chunk$set(autodep = TRUE, message = FALSE, warnings = FALSE)
```

```{r s2loadin}
s2raw <- read_csv(here::here("data", "MusicEmotionRegulation_November18_Prolific.csv"))

names(s2raw)


s2 <- s2raw %>% 
  mutate(rrq_6 = 6 - rrq_6,
         rrq_9 = 6 - rrq_9,
         rrq_10 = 6 - rrq_10,
         musebaq = rowSums(dplyr::select(., musebaq_1:musebaq_9)),
         Baseline = rowSums(dplyr::select(., deq_1_1:deq_1_4)),
         PostInduction = rowSums(dplyr::select(., deq_2_1: deq_2_4)),
         PostListening = rowSums(dplyr::select(., deq_3_1: deq_3_4)), 
         dif = PostListening - PostInduction
         ) 


s2 <- s2 %>% 
  mutate(rumination = rowMeans(dplyr::select(., rrq_1:rrq_12), na.rm = FALSE))

s2 %>% 
  dplyr::select(Baseline,
                PostInduction,
                PostListening,
                rumination,
                musebaq,
                hours.listen,
                reg.use_1,
                age) %>% 
  psych::describe()

write_csv(s2, here::here("data", "MusicEmotionRegulation_November18_Prolific_Processed.csv"))

# s2 %>% var_labels(mecscale_1 = "brainstem",
#                         mecscale_2 = "Entrainment",
#                         mecscale_3 = "Memory", 
#                         mecscale_4 = "Conditioning",
#                         mecscale_5 = "Imagery",
#                         mecscale_6 = "Contagion", 
#                         mecscale_7 = "Expectancy",
#                         mecscale_8 = "Appraisal", 
#                   reg.use_1 = "Regulatory Use Probability")
```

# Reliabilities 

```{r s2alphas, echo = FALSE}

baseline <- psych::alpha(dplyr::select(s2, deq_1_1:deq_1_4))$total$raw_alpha
postinduction <- psych::alpha(dplyr::select(s2, deq_2_1:deq_2_4))$total$raw_alpha
postlistening <- psych::alpha(dplyr::select(s2, deq_3_1:deq_3_4))$total$raw_alpha
rumalpha <- psych::alpha(dplyr::select(s2, rrq_1:rrq_12))$total$raw_alpha
musebaqalpha<- psych::alpha(dplyr::select(s2, musebaq_1:musebaq_9))$total$raw_alpha

```

The alpha for the DEQ - Sadness at Baseline was `r baseline`

The alpha for the DEQ DEQ - Sadness at Post Induction  was `r postinduction`

The alpha for the DEQ _ Sadness at post Listening was `r postlistening`

The alpha for rumination scores was `r rumalpha`

The alpha for the cognitive and emotion regulation scale of the MUSEBAQ was `r musebaqalpha`


# Manipulation Check

```{r manipulationcheck, results = 'hide'}
s2Manipulation <- t.test(s2$PostInduction, s2$Baseline, paired = TRUE) 

apa::t_apa(s2Manipulation)
apa::t_apa(s2Manipulation, format = "rmarkdown")

```
The manipulation/induction of sadness was succesful, `r apa_print(t.test(s2$PostInduction, s2$Baseline, paired = TRUE))$full_result *t*(381)` = 14.01, *p* < .001, *d* = 0.72, with scores rising from baseline (*M* `r printnum(mean(s2$Baseline))`, *SD* = `r printnum(sd(s2$Baseline))` to Post induction (*M* = `r printnum(mean(s2$PostInduction))`, *SD* = `r printnum(sd(s2$PostInduction))`)

# Hypothesis Test 

A significant interaction was found. 
```{r message = FALSE}

s2long <- s2 %>% 
  gather(key = Timepoint,
         value = Sadness,
         factor_key = TRUE,
         PostInduction, PostListening) 

write_csv(s2long, here::here("data", "MusicEmotionRegulation_November18_Prolific_Processed_Long.csv"))

library(lmerTest)
library(sjPlot)

s2glmm <- lmerTest::lmer(Sadness~1 + Timepoint + rumination + Timepoint:rumination + (1 |id), data = s2long)

tab_model(s2glmm, 
          show.std = TRUE)

```

```{r setupemmeans}

emmeans::ref_grid(s2glmm) # Add means and std dev to ref grid 

minus <- mean(s2$rumination, na.rm = TRUE) - sd(s2$rumination, na.rm = TRUE)
mean <- mean(s2$rumination, na.rm = TRUE)
plus <- mean(s2$rumination, na.rm = TRUE) + sd(s2$rumination, na.rm = TRUE)


s2glmmgrid <- emmeans::ref_grid(s2glmm, 
                                at = list(Timepoimt = c("PostIndcution", "PostListening"), 
                                          rumination = c(minus, mean, plus)))

```


```{r plot effects}
emmeans::emmip(s2glmmgrid, rumination~Timepoint, 
               CIs = TRUE) +
  ggplot2::scale_fill_discrete(labels = c("-1 SD", "mean", "+1 SD"))
              
```

The main effect copmparions show that sadness increased from pre (*M* = `r mean(s2$PostInduction)`, *SD* = `r sd(s2$PostInduction)`) to post (*M* = `r mean(s2$PostListening)`, *SD* = `r sd(s2$PostListening)`)

```{r posthocConfirmS2}

emmeans::emmeans(s2glmmgrid, pairwise ~Timepoint)

emmeans::eff_size(emmeans(s2glmm, "Timepoint"),
                  sigma = sigma(s2glmm), 
                  edf = df.residual(s2glmm))

emmeans::emtrends(s2glmm, 
                  specs = "Timepoint",
                  var = "rumination"
                  )
```



The simple effects showed that sadness increased for all levels of rumunation 
```{r simpleslopes}



s2SimpleList <- list(rumination = c(minus, plus, mean), Timepoint = c("PostInduction", "PostListening"))

s2SimpleSlopes <- emmeans::emmeans(s2glmm, ~rumination*Timepoint, at = s2SimpleList)

emmeans::contrast(s2SimpleSlopes, "pairwise", by = "rumination")
```

